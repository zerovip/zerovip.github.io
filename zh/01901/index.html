<!DOCTYPE html>
<html class="theme-container">
<head>
<meta charset="utf-8"/>
<meta content="width=divice-width,initial-scale=1" name="viewport"/>
<meta content="Hugo 0.87.0" name="generator"/>
<title>
如何让静态网站的暗色主题换页不闪烁
| 赤赤的象牙塔
</title>
<link href="../../css/base.min.be04117b27bfebd71cb4589d34a23e06b2a360d9fe05dff9134c8d8173864408.css" rel="stylesheet" type="text/css"/>
<link href="../../css/small.min.fc3c637453c4bb37cfe95f39f0a9bd491c0f8186e381262a1fde3fd405e376d9.css" media="screen and (max-width: 1200px)" rel="stylesheet" type="text/css"/>
<link href="../../css/normal.min.87ca6c8fd77d7c0e32a8b8cd398fdc5de88c7a2bf7315fef839791ffed301990.css" media="screen and (min-width: 1201px)" rel="stylesheet" type="text/css"/>
<script src="../../js/ctheme.min.2b9744ea6df95f636aae562954ce13add68a9c7b99203c9ac1aa4671b6238958.js" type="text/javascript"></script>
<link href="../../css/syntax.min.ed5b37c3a50997d5ccd8b81bf0d00a7ac1f92c82985623c2dbf0cb422596726a.css" rel="stylesheet" type="text/css"/>
<script type="application/javascript">var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-143006759-1','auto'),ga('send','pageview'))</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script async="" data-goatcounter="https://zerovip.goatcounter.com/count" src="//gc.zgo.at/count.js"></script>
</head>
<body>
<div class="bar_for_phone">
<div class="bar_left_button">
<div class="left_button_for_bar" onclick="ChangeClassLeft()">
<div class="bar1"></div>
<div class="bar2"></div>
<div class="bar3"></div>
</div>
</div>
<div class="bar_title">
<a href="../../zh/">赤赤的象牙塔</a>
</div>
<div class="bar_right_button">
<button class="toc_title_for_bar" onclick="ChangeClassTOC()">目录</button>
</div>
</div>
<div class="body_for_pc">
<div class="left" id="left">
<div class="left_non-footer">
<div class="left_non-footer_option">
<div class="theme-switch">
<label class="switch">
<input checked="" class="theme-switcher" onchange="themeSwitch()" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
<li><br/></li>
<li class="left_non-footer_option_active">
简体中文 ⦿
</li>
<li class="left_non-footer_option_non-active">
English ⨂
</li>
<li class="left_non-footer_option_non-active">
Français ⨂
</li>
<li><br/></li>
<li class="left_non-footer_option_non-active">
RSS 订阅 ⊠
</li>
<li><br/></li>
</div>
<div class="left_non-footer_head">
<div class="left_non-footer_head_title">
<a href="../../zh/">
赤赤的象牙塔
</a>
</div>
<div class="left_non-footer_head_subtitle">(●’◡’●)ﾉ</div>
</div>
<div class="left_non-footer_main">
<div class="h1">
<a href="../../zh/math/">数学</a>
</div>
<div class="h2">
<a href="../../zh/math/notes/">数学笔记 </a>
</div>
<div class="h2">
<a href="../../zh/math/stories/">数学科普 </a>
</div>
<div class="h1 active">
<a href="../../zh/non-math/">非数学</a>
</div>
<div class="h2">
<a href="../../zh/non-math/journal/">日志 </a>
</div>
<div class="h2">
<a href="../../zh/non-math/literature/">写作 </a>
</div>
<div class="h2 active">
<a href="../../zh/non-math/memos/">备忘 </a>
</div>
<div class="h1">
<a href="../../zh/record/">记录</a>
</div>
<div class="h2">
<a href="../../zh/record/book/">读过的书 </a>
</div>
<div class="h2">
<a href="../../zh/record/film/">看过的电影 </a>
</div>
<div class="h1">
<a href="../../zh/about/">关于</a>
</div>
<div class="h2">
<a href="../../zh/about/me/">关于我 </a>
</div>
<div class="h2">
<a href="../../zh/about/site/">关于本站 </a>
</div>
</div>
</div>
<div class="left_footer">
<div class="copyright">©2019-2021 版权所有.</div>
</div>
</div>
<div class="right" onclick="HideBothSide()">
<div class="right_head">
<div class="right_head_title">
如何让静态网站的暗色主题换页不闪烁
</div>
<div class="right_head_des">
2021年8月27日 - 955 字
</div>
</div>
<div class="right_main">
<div class="right_main_article">
<h1 id="问题">
问题
<a href="#%e9%97%ae%e9%a2%98"><small>¶</small></a>
</h1>
<p>我写的这个 Hugo 主题之前一直有个毛病. 它默认是亮色主题，但如果调到暗色主题<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" role="doc-noteref">1</a></sup>，那么加载新页面时网站会先渲染亮色主题，然后再自动切换到暗色主题，观感上就是它闪烁了一下. 我本来以为这是静态网站的通病，直到我看到别人的主题就没这个毛病，比如 <a href="https://adityatelange.github.io/hugo-PaperMod/" rel="noreferrer noopener" target="_blank">PaperMod<b><sub>⧉</sub></b></a>. 所以这个问题是一定有解决方案的.</p>
<p>我先查了一下，<a href="https://github.com/zwbetz-gh/cupper-hugo-theme" rel="noreferrer noopener" target="_blank">Cupper 主题<b><sub>⧉</sub></b></a>的维护者写过一篇文章：<a href="https://zwbetz.com/fix-the-white-flash-on-page-load-when-using-a-dark-theme-on-a-static-site/" rel="noreferrer noopener" target="_blank">Fix the White Flash on Page Load When Using a Dark Theme on a Static Site<b><sub>⧉</sub></b></a>. 我试了 ta 的方案，Chrome 浏览器下此方案确实解决了问题，但是 Firefox 下问题依然存在：Firefox 会把 <code>visibility: hidden; opacity: 0;</code> 渲染成白色，等 <code>DOMContentLoaded</code> 事件发生后，<code>showContent()</code> 函数再把内容展示出来，也就是说它还是会闪烁，只不过之前是闪一下<strong>亮色主题</strong>，现在是闪一下<strong>纯白页</strong>，实际观感同样糟糕.</p>
<p>Firefox 与 Chrome 的差异我觉得更像是 Chrome 的开发者使用了魔法，来帮助其用户获得更好的使用体验，同时这也掩盖了真正的问题，迷惑了使用 Chrome 浏览器的 Hugo 主题开发者.</p>
<h1 id="找到问题的根源">
找到问题的根源
<a href="#%e6%89%be%e5%88%b0%e9%97%ae%e9%a2%98%e7%9a%84%e6%a0%b9%e6%ba%90"><small>¶</small></a>
</h1>
<p>核心的思路仍然是理解浏览器渲染页面的流程. 简单来说：</p>
<ul>
<li>你请求了一个网页；</li>
<li>浏览器先把整个 HTML 下载下来，存成 DOM，然后从上到下依次解析、渲染页面；</li>
<li>遇到外链的 CSS 或 JavaScript 就停止解析，先去把外链的文件下载回来装载上再继续；</li>
<li>遇到 <code>&lt;style&gt;&lt;/style&gt;</code> 或刚刚装载了外部的 CSS 就把样式表存成 CSSOM 并重新渲染有影响的部分；</li>
<li>遇到 <code>&lt;script&gt;&lt;/script&gt;</code> 或刚刚装载了外部的 JavaScript 就停止解析并运行脚本，运行完脚本后再继续解析、渲染；</li>
<li>以此类推，直到完成.</li>
</ul>
<p>而发生闪烁问题的原因就在于我把判断颜色的 JavaScript 脚本放在了 <code>&lt;body&gt;</code> 的最后，像这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- lots of stuff…… --&gt;</span>

        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"changeTheme.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="解决">
解决
<a href="#%e8%a7%a3%e5%86%b3"><small>¶</small></a>
</h1>
<p>问题的解决其实也简单，核心有二：</p>
<ul>
<li>
<ol>
<li>把读取主题的脚本放进 <code>&lt;head&gt;</code> 里，这样刚刚加载还没开始渲染时就能够确定用户当前选择的主题；</li>
</ol>
</li>
<li>
<ol start="2">
<li>把更改主题的容器提升成整个 <code>&lt;html&gt;</code>，即：从原来的</li>
</ol>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span> <span class="na">class</span><span class="o">=</span><span class="s">"theme-container"</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>变成现在的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span> <span class="na">class</span><span class="o">=</span><span class="s">"theme-container"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>这是因为 <code>&lt;body&gt;</code> 在这个时候还没有被渲染，<code>&lt;head&gt;</code> 里的脚本能操作的对象只有 <code>&lt;html&gt;</code>.</p>
<hr/>
<p>至此问题完全解决，完整的代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">class</span><span class="o">=</span><span class="s">"theme-container"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- lots of stuff…… --&gt;</span>

        <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
            <span class="kr">const</span> <span class="nx">themeContainer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">".theme-container"</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">"theme"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">theme</span> <span class="o">==</span> <span class="s2">"dark"</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">themeContainer</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">"dark"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">theme</span> <span class="o">==</span> <span class="s2">"light"</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">themeContainer</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">"dark"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- lots of stuff…… --&gt;</span>

        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"others.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><section class="footnotes" role="doc-endnotes">
<hr/>
<ol>
<li id="fn:1" role="doc-endnote">
<p>本主题中暗色模式的实现方法为 CSS 变量，详见<a href="https://dev.to/lampewebdev/css-quickies-css-variables-or-how-you-create-a-white-dark-theme-easily-1i0i" rel="noreferrer noopener" target="_blank">这篇教程<b><sub>⧉</sub></b></a>. <a class="footnote-backref" href="#fnref:1" role="doc-backlink">↩︎</a></p>
</li>
</ol>
</section>
<p></p><p></p><p></p><p></p>
</div>
</div>
<div class="right_comments">
<script async="" crossorigin="anonymous" issue-term="pathname" repo="zerovip/bcsu" src="https://utteranc.es/client.js" theme="github-light"></script>
</div>
</div>
<div class="toc" id="toc">
<button class="toc_title">目录</button>
<div class="toc_content">
<nav id="TableOfContents">
<ul>
<li><a href="#问题">问题</a></li>
<li><a href="#找到问题的根源">找到问题的根源</a></li>
<li><a href="#解决">解决</a></li>
</ul>
</nav>
</div>
</div>
</div>
<script src="../../js/main.min.09f704e0a8070b3bf9bceadff3f53e38344d199eb99f6a52643c082c23945ce5.js" type="text/javascript"></script>
</body>
</html>