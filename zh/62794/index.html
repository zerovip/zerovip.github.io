<!DOCTYPE html><html lang="zh" class="theme-container"><head><meta charset="utf-8"/><meta name="viewport" content="width=divice-width,initial-scale=1"/><meta name="generator" content="Hugo 0.104.2"/><title>给 Aegisub 写 lua 脚本来辅助翻译既有字幕
| 赤赤的象牙塔</title><link rel="stylesheet" type="text/css" href="../../css/base.min.7a1b5c1c1d7e43ac09f0cd1df239e034cbdf5fa7439794fb7b5fe1225963173c.css"/><link rel="stylesheet" media="screen and (max-width: 1200px)" type="text/css" href="../../css/small.min.f9c67371e05b88a9468d51903bbe4d52be301b7e498d3f1dc7fbff95f35f2929.css"/><link rel="stylesheet" media="screen and (min-width: 1201px)" type="text/css" href="../../css/normal.min.7fe55f32650b9c713cce8ccc9a63d23eecaff2b247b70a69bf3650b249319609.css"/><link rel="stylesheet" type="text/css" href="../../css/syntax.min.ed5b37c3a50997d5ccd8b81bf0d00a7ac1f92c82985623c2dbf0cb422596726a.css"/><script src="../../js/ctheme.min.23d42d00e692299bcf2b5832c28a8a1582346c7c45d8bc4f70280fcdbf146872.js"></script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6CF2JBMYH3"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6CF2JBMYH3",{anonymize_ip:!1})}</script><script data-goatcounter="https://zerovip.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script></head><body><nav class="bar_for_phone"><div class="bar_left_button"><div class="left_button_for_bar" onclick="ChangeClassLeft()"><div class="bar1"></div><div class="bar2"></div><div class="bar3"></div></div></div><div class="bar_title"><a href="../../zh/">赤赤的象牙塔</a></div><div class="bar_right_button"><button class="toc_title_for_bar" onclick="ChangeClassTOC()">目录</button></div></nav><div class="body_for_pc"><aside class="left" id="left"><div class="left_non-footer"><div class="left_non-footer_option"><div role="checkbox" aria-checked="true" class="left_non-footer_option_theme-switch"><label class="switch"><input type="checkbox" class="theme-switcher" onchange="themeSwitch()"/>
<span class="slider round"></span></label></div><ul role="listbox" class="left_non-footer_option_language"><li role="option" aria-selected="true" class="left_non-footer_option_active">简体中文 ⦿</li><li role="option" class="left_non-footer_option_non-active">English ⨂</li><li role="option" class="left_non-footer_option_non-active">Français ⨂</li></ul><div class="left_non-footer_option_rss"><div class="left_non-footer_option_non-active">RSS 订阅 ⊠</div></div></div><header class="left_non-footer_head"><div class="left_non-footer_head_title"><a href="../../zh/">赤赤的象牙塔</a></div><div class="left_non-footer_head_subtitle">(●’◡’●)ﾉ</div></header><nav class="left_non-footer_main"><div class="h1"><a href="../../zh/math/">数学</a></div><div class="h2"><a href="../../zh/math/notes/">数学笔记</a></div><div class="h2"><a href="../../zh/math/stories/">数学科普</a></div><div class="h1 active"><a href="../../zh/non-math/">非数学</a></div><div class="h2"><a href="../../zh/non-math/journal/">日志</a></div><div class="h2"><a href="../../zh/non-math/literature/">写作</a></div><div class="h2 active"><a href="../../zh/non-math/memos/">备忘</a></div><div class="h1"><a href="../../zh/record/">记录</a></div><div class="h2"><a href="../../zh/record/book/">读过的书</a></div><div class="h2"><a href="../../zh/record/film/">看过的电影</a></div><div class="h1"><a href="../../zh/about/">关于</a></div><div class="h2"><a href="../../zh/about/me/">关于我</a></div><div class="h2"><a href="../../zh/about/site/">关于本站</a></div></nav></div><footer class="left_footer"><div class="copyright">©2019-2022 版权所有.</div></footer></aside><div class="right" onclick="HideBothSide()"><header class="right_head"><div class="right_head_title">给 Aegisub 写 lua 脚本来辅助翻译既有字幕</div><div class="right_head_des">2021年3月31日 - 7025 字</div></header><div class="right_main"><article class="right_main_article"><p>这篇文章本质上是一个流水帐记录，未必有参考价值. 如果参考的话，读者本身需要有一定的编程基础，懂一点点 lua，同时还要对 Aegisub 软件有一点了解.</p><h1 id="背景与需求">背景与需求
<a href="#%e8%83%8c%e6%99%af%e4%b8%8e%e9%9c%80%e6%b1%82"><small>¶</small></a></h1><p>看了纪录片《波士顿市政厅》（<em>City Hall</em>），因为没有看到这部纪录片有中文字幕，就一直想自己翻译一个出来，帮助其他想看的人.</p><p>我手里已经有这部纪录片的英文字幕了，而且时间轴都是对齐的，因此可以直接在原有时间轴上进行翻译. 如果没有本来的字幕，则应该按照大多数字幕组的工作流程，先听写、断句、打轴，然后再翻译. 这篇文章默认已经拥有了时间轴对齐的原文，只剩下翻译的工作要做. 我使用 Aegisub 软件，我的工作环境是 Linux.</p><p>为了放便感兴趣的读者动手尝试，我在这里提供一个字幕文件样本，里面只保留了前 20 行的字幕内容，使用它可以完整地操作这篇文章中的所有步骤. 点击<a href="CityHall.srt" download="">这里</a>下载.</p><h1 id="思路与流程">思路与流程
<a href="#%e6%80%9d%e8%b7%af%e4%b8%8e%e6%b5%81%e7%a8%8b"><small>¶</small></a></h1><p>打开 Aegisub 软件，点击菜单栏 - “文件” - “打开字幕”，选择手头已经有的英文字幕文件 <code>CityHall.srt</code>. 然后：</p><ol><li>点击菜单栏 - “字幕” - “样式管理器”，在左边样式库下边点击“新建”，“样式名称”填入“English”，然后为英文字幕的样式做一些配置，点击“确定”保存；</li><li>再次在左边样式库下边点击“新建”，“样式名称”填入“中文”，然后为中文字幕的样式做一些配置，点击“确定”保存；</li><li>在左边样式库中分别选中“English”和“中文”，点击“复制到当前脚本-&gt;”，把这两种样式应用到当前的工作环境中，然后点击“关闭”关掉样式管理器窗口；</li><li>用鼠标拖拽或使用 <code>Ctrl + A</code> 选中所有字幕，在字幕编辑框里的样式下拉菜单中选择“English”；</li><li>鼠标右键，选择“重复行”，这时选中的字幕应该是新重复出来的那些行；</li><li>在字幕编辑框里的样式下拉菜单中选择“中文”；</li><li>点击菜单栏 - “字幕” - “翻译助手”，对[重复出来的那些、我们选择了“中文”样式的行]进行逐行翻译，每翻译好一句以后按 <code>Enter</code> 键确认并翻译下一行，直到完成；</li><li>英文的字幕里有一些换行符 <code>\N</code>，我们希望把它们替换成空格；</li><li>我们希望把所有字幕按时间进行重新排序，即一行英文一行中文，这样也方便我们查看；</li><li>整体检查一遍，输出字幕文件，整个工作完成.</li></ol><h1 id="遇到的问题">遇到的问题
<a href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98"><small>¶</small></a></h1><p>这些工作中，1 - 6 条都非常容易，动动鼠标就能完成；第 7 条费点事，但这是我能找到的最方便的翻译字幕的办法了——当然更简单的做法是写个脚本，用 Google 翻译先弄出一个机翻出来，然后再用第 7 条这里的办法订正一遍；第 8 条非常适合使用脚本来做.</p><p>第 9 条其实可做可不做，跳过第 9 条，直接输出字幕文件也未尝不可. 但我习惯最后再从头到尾一边播放视频一边检查一遍，检查的时候可能会对字幕再做点细微的更改. 问题就此出现：我们既可能修改某一条英文字幕，又可能修改某一条中文字幕，如果所有英文字幕集中在上边，所有中文字幕集中在下边，那就要经常上下滚动翻找，十分不方便. 因此，第 9 条还是很有必要的.</p><p>综上所述，这篇文章要写两个 lua 脚本，解决两个问题：第 8 条和第 9 条.</p><h1 id="脚本放在哪里">脚本放在哪里？
<a href="#%e8%84%9a%e6%9c%ac%e6%94%be%e5%9c%a8%e5%93%aa%e9%87%8c"><small>¶</small></a></h1><p>打开 Aegisub，点击菜单栏 - “查看” - “选项” - “自动化”，看一下“自动载入路径”：</p><blockquote><p><code>?user/automation/autoload/|?data/automation/autoload/</code></p></blockquote><p>这里有两个变量，在我的 Linux 下：</p><ul><li>变量 <code>?user</code> 的含义是：<code>~/.aegisub/</code></li><li>变量 <code>?data</code> 的含义是：<code>/usr/share/aegisub/</code></li></ul><p>综上所述，我们可以把自己写的脚本放在 <code>~/.aegisub/automation/autoload/xxx.lua</code>，然后从 Aegisub 那边点击菜单栏 - “自动化” - “自动化” - “重新扫描自动载入文件夹”，这样就能看到我们自己的脚本了.</p><h1 id="去掉换行符">去掉换行符
<a href="#%e5%8e%bb%e6%8e%89%e6%8d%a2%e8%a1%8c%e7%ac%a6"><small>¶</small></a></h1><p>我们先来完成第 8 条的任务，把字幕中的换行符 <code>\N</code> 替换成空格. 脚本如下：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="cm">--[[
</span></span></span><span class="line"><span class="cl"><span class="cm">说明：
</span></span></span><span class="line"><span class="cl"><span class="cm">    这个脚本是用来去除字幕中的 \N.
</span></span></span><span class="line"><span class="cl"><span class="cm">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 一些描述性的信息</span>
</span></span><span class="line"><span class="cl"><span class="n">script_name</span> <span class="o">=</span> <span class="s1">&#39;去掉换行&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_description</span> <span class="o">=</span> <span class="s1">&#39;把每一行字幕中的 `</span><span class="se">\\</span><span class="s1">N` 去掉.&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_author</span> <span class="o">=</span> <span class="s1">&#39;Zero&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_version</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 这是我们的函数，第 38 行保证了它会被执行.</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">strip</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 对选中行进行遍历</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">i</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 取出字幕</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">line</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 对字幕进行一些操作</span>
</span></span><span class="line"><span class="cl">        <span class="n">line.text</span> <span class="o">=</span> <span class="n">string.gsub</span><span class="p">(</span><span class="n">line.text</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">N&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 把操作好的字幕再放回去</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">-- 设置一个撤销点</span>
</span></span><span class="line"><span class="cl">    <span class="n">aegisub.set_undo_point</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">-- 保持选中行仍然是选中状态</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">sel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 为上面的函数进行注册</span>
</span></span><span class="line"><span class="cl"><span class="n">aegisub.register_macro</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">script_description</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>具体的解释见下面两个小节.</p><h2 id="脚本的结构">脚本的结构
<a href="#%e8%84%9a%e6%9c%ac%e7%9a%84%e7%bb%93%e6%9e%84"><small>¶</small></a></h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="cm">--[[
</span></span></span><span class="line"><span class="cl"><span class="cm">说明：
</span></span></span><span class="line"><span class="cl"><span class="cm">    这个脚本是用来去除字幕中的 \N.
</span></span></span><span class="line"><span class="cl"><span class="cm">]]</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ul><li>第 1 - 4 行是 lua 的注释语句，我们一般会在脚本的最开始用这样的格式对这个脚本的用途、许可证等问题进行一定的说明；</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 一些描述性的信息</span>
</span></span><span class="line"><span class="cl"><span class="n">script_name</span> <span class="o">=</span> <span class="s1">&#39;去掉换行&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_description</span> <span class="o">=</span> <span class="s1">&#39;把每一行字幕中的 `</span><span class="se">\\</span><span class="s1">N` 去掉.&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_author</span> <span class="o">=</span> <span class="s1">&#39;Zero&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_version</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ul><li>第 7 - 10 行是一些对这个脚本的描述，它们会显示在菜单栏 - “自动化” - “自动化”打开的窗口中，并通过第 38 行函数的第一个参数显示为菜单栏 - “自动化” - “去掉换行”；</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 为上面的函数进行注册</span>
</span></span><span class="line"><span class="cl"><span class="n">aegisub.register_macro</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">script_description</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ul><li>第 38 行除了将脚本名、脚本描述进行注册以外，还注册了一个函数 <code>strip</code>，这个函数就是在 Aegisub 中点击“去掉换行”之后会执行的函数了；</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 这是我们的函数，第 38 行保证了它会被执行.</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">strip</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">-- 对选中行进行遍历</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">i</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 取出字幕</span>
</span></span><span class="line"><span class="cl">        <span class="kd">local</span> <span class="n">line</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 对字幕进行一些操作</span>
</span></span><span class="line"><span class="cl">        <span class="n">line.text</span> <span class="o">=</span> <span class="n">string.gsub</span><span class="p">(</span><span class="n">line.text</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">N&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">-- 把操作好的字幕再放回去</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">-- 设置一个撤销点</span>
</span></span><span class="line"><span class="cl">    <span class="n">aegisub.set_undo_point</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">-- 保持选中行仍然是选中状态</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">sel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ul><li>第 13 - 35 行就是定义的函数 <code>strip</code> 的函数体，它接受了 sub 和 sel 两个参数：<ul><li><code>sub</code>：第一参数是整个字幕中的所有数据，里面包含的东西非常非常多，我们不需要知道它里面各种数据的组织形式，只需要知道用 <code>sub[num]</code> 能取出第 <code>num</code> 行的字幕就可以了.</li><li><code>sel</code>：第二个参数是一个 table，它表示当前用户在 Aegisub 软件里选中的那些行，键就是从 1 开始的递增序列，值则是其对应的行号.</li><li>实际上，还有第三个参数是可选的，用来表示当前激活的那一行字幕. 一般情况下都用不太到.</li></ul></li><li>第 16 - 27 行的 <code>for</code> 循环基本上就是很多 lua 脚本的固定套路了，先按行遍历把字幕取出来，然后对字幕进行一些操作，最后再把操作完成后的字幕放回去. 这里一定要参考的是官方文档中的 Dialogue line table 部分，看一看每一行取出来的是什么数据类型，它有哪些可以拿来用的域. 就像这里的 <code>line.text</code>，其实还有 <code>line.class</code>, <code>line.raw</code>, <code>line.section</code>, <code>line.comment</code>, <code>line.layer</code>, <code>line.start_time</code>, <code>line.end_time</code> 等等等等.</li><li>第 30 行是设置一个撤销点，这样一来，通过菜单栏 - “自动化” - “去掉换行”运行了这个脚本以后，可以通过菜单栏 - “编辑” - “恢复 去掉换行”来撤销操作. 实际上，从 Aegisub 3.0 版本以后，这句话即便没有写，软件也会自动帮你生成撤销点，但我们还是养成一个良好的习惯，把它写上. 而且通过这句话可以自主指定撤销点的名字.</li><li>第 33 行是函数的返回值，返回值应该是一个 table，里面是一些行号，软件则在执行完该脚本后将返回值里面的那些行高亮选中. 像这里，我们就还是返回第 2 个参数 <code>sel</code>，表示那些被选中的行依然保持被选中的状态.</li></ul><h2 id="lua-代码中要注意的细节">lua 代码中要注意的细节
<a href="#lua-%e4%bb%a3%e7%a0%81%e4%b8%ad%e8%a6%81%e6%b3%a8%e6%84%8f%e7%9a%84%e7%bb%86%e8%8a%82"><small>¶</small></a></h2><p>关于 lua 需要注意的有三点：</p><ul><li>lua 的变量是区分 global 和 local 的，大多数情况下我们用局部变量就够了，要在变量名称前加上 <code>local</code>.</li><li><code>for</code> 循环里的 <code>pairs</code> 和 <code>ipairs</code> 是有区别的，前者对索引没有要求，后者要求索引必须是从 <code>1</code> 开始单调递增. 第二个参数 <code>sel</code> 恰好满足后者的条件，所以我们在这里用 <code>ipairs</code>. 这里的 <code>_, i</code> 其实就是键值对，键是从 <code>1</code> 开始单调递增的，在代码中没有什么用，所以我们就用下划线 <code>_</code> 不要它就行了；值是用户在 Aegisub 里选中的那些行号，用这些行号可以取出第一个参数 <code>sub</code> 里面的字幕.</li><li>lua 关于字符串的处理需要自行学习掌握，这里使用了 <code>string.gsub</code>，这个还是相当好用的.</li></ul><h1 id="将中英文字幕混排">将中英文字幕混排
<a href="#%e5%b0%86%e4%b8%ad%e8%8b%b1%e6%96%87%e5%ad%97%e5%b9%95%e6%b7%b7%e6%8e%92"><small>¶</small></a></h1><p>现在还剩第 9 条任务，把所有字幕按时间进行重新排序，即一行英文一行中文. 先分析一下：我们已经有的是上半截英文、下半截中文的字幕，它们的顺序都是正确的，只要把它们穿插起来就行了. 那我们只要先预先判断一下，看看用户选择的行（需要用户提前全选或选择一部分）的总数是不是偶数，如果是偶数的话就把它们从中间一分为二，然后从上半部分取一行、从下半部分取一行，如此循环，也就完成了我们的任务. 代码如下：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="cm">--[[
</span></span></span><span class="line"><span class="cl"><span class="cm">说明：
</span></span></span><span class="line"><span class="cl"><span class="cm">    把中文的字幕和翻译好的英文字幕穿插在一起. 要求用户所选行数一定要是偶数，
</span></span></span><span class="line"><span class="cl"><span class="cm">    且一半英文字幕、一半中文字幕，都是按照相同的顺序上下对应起来的.
</span></span></span><span class="line"><span class="cl"><span class="cm">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">script_name</span> <span class="o">=</span> <span class="s1">&#39;双语穿插&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_description</span> <span class="o">=</span> <span class="s1">&#39;把中文的字幕和翻译好的英文字幕穿插在一起.&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_author</span> <span class="o">=</span> <span class="s1">&#39;Zero&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_version</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">mix</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">sub_backup</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">subi</span><span class="p">,</span> <span class="n">seli</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub_backup</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">slen</span> <span class="o">=</span> <span class="o">#</span><span class="n">sel</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">subi</span><span class="p">,</span> <span class="n">seli</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">subi</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">~=</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- 索引是奇数，英文，加 1 再除以 2，在 sel 里取出这个索引的值.</span>
</span></span><span class="line"><span class="cl">            <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_backup</span><span class="p">[</span><span class="n">sel</span><span class="p">[(</span><span class="n">subi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="kr">elseif</span> <span class="n">subi</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- 索引是偶数，中文，加 n 再除以 2，在 sel 里取出这个索引的值.</span>
</span></span><span class="line"><span class="cl">            <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_backup</span><span class="p">[</span><span class="n">sel</span><span class="p">[(</span><span class="n">subi</span> <span class="o">+</span> <span class="n">slen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">aegisub.set_undo_point</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">sel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- 验证函数</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">mix_validation</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="o">#</span><span class="n">sel</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">aegisub.register_macro</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">script_description</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mix_validation</span><span class="p">)</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>具体的解释见下面两个小节.</p><h2 id="关于-aegisub-的验证函数">关于 Aegisub 的验证函数
<a href="#%e5%85%b3%e4%ba%8e-aegisub-%e7%9a%84%e9%aa%8c%e8%af%81%e5%87%bd%e6%95%b0"><small>¶</small></a></h2><ul><li>第 43 行，这里的注册函数和之前的有所不同，还多注册了一个 <code>mix_validation</code> 函数. 这个函数作为注册函数的第 4 个参数，表示软件要预先判断一下目前的状况能不能运行这个脚本.</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- 验证函数</span>
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">mix_validation</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="o">#</span><span class="n">sel</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ul><li>第 39 - 41 行就是这里注册的验证函数. 这里的验证函数很简单，就是看一下当前用户选择的行的总数能否被 2 整除，如果可以就返回 <code>true</code>，如果不行就返回 <code>false</code>. 体现在软件的操作上就是：如果你选择的行的数量是偶数，那么在菜单栏 - “自动化” 里就能点击“双语穿插”来运行这个脚本；如果你选择的行的数量是奇数，那么在菜单栏 - “自动化”里，你会看到灰色的“双语穿插”，不能点击，表示目前这种情况下你不能运行这个脚本.</li><li>第 12 - 36 行就是这个脚本的核心，比起之前的脚本，这个要稍稍复杂一点点. 我们在下一小节稍稍做点解释.</li></ul><h2 id="lua-代码中要注意的细节-1">lua 代码中要注意的细节
<a href="#lua-%e4%bb%a3%e7%a0%81%e4%b8%ad%e8%a6%81%e6%b3%a8%e6%84%8f%e7%9a%84%e7%bb%86%e8%8a%82-1"><small>¶</small></a></h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">slen</span> <span class="o">=</span> <span class="o">#</span><span class="n">sel</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="kr">for</span> <span class="n">subi</span><span class="p">,</span> <span class="n">seli</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">subi</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">~=</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 索引是奇数，英文，加 1 再除以 2，在 sel 里取出这个索引的值.</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_backup</span><span class="p">[</span><span class="n">sel</span><span class="p">[(</span><span class="n">subi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">elseif</span> <span class="n">subi</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- 索引是偶数，中文，加 n 再除以 2，在 sel 里取出这个索引的值.</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_backup</span><span class="p">[</span><span class="n">sel</span><span class="p">[(</span><span class="n">subi</span> <span class="o">+</span> <span class="n">slen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>第 20 - 30 行的代码和注释已经足够清楚了，这就是完成穿插的核心代码，主要是数学上的逻辑：判断行号是奇数还是偶数，如果是奇数就从上半部分英文的部分选一行放进来，如果是偶数就从下半部份中文的部分选一行放进来.</p><p>第 14 - 18 行的操作值得一说.</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="kd">local</span> <span class="n">sub_backup</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="kr">for</span> <span class="n">subi</span><span class="p">,</span> <span class="n">seli</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_backup</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>14 - 18 行做的是把用户选中的那些字幕复制一份出来作为备份，这样在 <code>sub</code> 这个变量上随心所欲地做一些改动就不会影响到备份出来的原始数据了. 这里的关键在于，<a href="http://lua-users.org/wiki/CopyTable" target="_blank" rel="noreferrer noopener">lua 用 <code>=</code> 传递 table 或 userdata 的本质是引用<b><sub>⧉</sub></b></a>，对其中一个做更改会影响到另一个，所以我们必须自己手动把它们复制出来. 举个例子：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">old</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">new</span> <span class="o">=</span> <span class="n">old</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">old</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">old</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">-- output：1 2 3</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">-- output：1 2 3</span>
</span></span><span class="line"><span class="cl"><span class="n">old</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;interesting&#39;</span>        <span class="c1">--对旧的变量做一些更改</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">old</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">old</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">-- output：interesting 2 3</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">-- output：interesting 2 3</span>
</span></span><span class="line"><span class="cl">                              <span class="c1">--导致新的变量也同步了那个更改</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>实际上，这样的语言有很多，大部分引用语义的语言都是传引用的. 比如 java, javascript, python. 一个 python 的例子如下：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">old</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">new</span> <span class="o">=</span> <span class="n">old</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="c1"># output：[1, 2, 3]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="c1"># output：[1, 2, 3]</span>
</span></span><span class="line"><span class="cl"><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;interesting&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="c1"># output：[&#39;interesting&#39;, 2, 3]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="c1"># output：[&#39;interesting&#39;, 2, 3]</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>实话说，我以为我对 python 还算是熟悉，但我真的第一次知道这件事. 好像之前没有遇到过这种操作吧？总之这是写这份脚本时遇到的一个小小的坑.</p><h1 id="其他">其他
<a href="#%e5%85%b6%e4%bb%96"><small>¶</small></a></h1><p>有了上面两个脚本的帮助，我们就能快速把 1 - 9 完成了. 在输出字幕之前，我一般还会做点微小的调整：点击菜单栏 - “计时” - “时间后续处理器”，关闭“开始提前”，保留“结束延后”，并设置结束延后的时长为 500 ms，然后启用相邻字幕行连续的功能. 这是为了使字幕在台词说完以后还能再显示半秒，给观众一个更舒适的时间来阅读字幕；另外对于两行时间非常接近的字幕，就让第二行开始的时间作为第一行结束的时间，不会看起来一闪一闪的. 这个技巧来自 <a href="https://www.bilibili.com/video/BV1ps411b7as" target="_blank" rel="noreferrer noopener">b 站教程：快速打轴法<b><sub>⧉</sub></b></a>.</p><p>至此，所有任务完成，我感受到了自己写脚本的强大之处. 总的来说，Aegisub 的 lua 脚本并不难写，思路理解起来也非常自然，以后在做字幕的时候遇到任何麻烦的事情就都可以用脚本来做了，这次的学习性价比极高！</p><div role="note" class="notation_color"><p>补充一个翻译视频内说明文字的流程：</p><ol><li>在下面字幕区所有字幕的最后一行右键，选择“插入（之后）”；</li><li>在上面的字幕编辑区把样式改成“Default”；</li><li>内容写：<code>{\fnSerif\fs72\b1\pos(100,100)}示例文本</code>；</li><li>把定位的方式改成“帧(R)”而不是“时间(I)”，用帧来定位比较好记，是一个整数；</li><li>把开始时间和结束时间都设置为 0；</li><li>在下面字幕区右键这一行字幕，选择“重复行”，反复这样多做几次，重复出足够的行出来，作为所有视频内文字说明的初始状态空模板；</li><li>在视频预览区开始从头到尾播放视频，遇到需要翻译的视频内的说明文字就暂停一下，记录一下初始和结束时刻的帧数；</li><li>找一个初始状态空模板字幕，点击一下（视频会跳到第 0 帧但是没关系），在上面的字幕编辑区把“开始时间”和“结束时间”改成刚刚记下的帧数；</li><li>确保视频预览区下方“自动将视频移至所选字幕的开始时间”是选中的状态，然后在下面的字幕区点击这条字幕，这时视频就会自动跳转到刚刚输入的开始时间的帧数；</li><li>播放视频，一来再次确认一下开始时间和结束时间是否需要做些微调，二来阅读视频内的说明文字，准备翻译；</li><li>在上面的字幕编辑区完成字幕的翻译，然后在视频预览区左边，点击第二个按钮，是一个十字形的“拖放字幕(R)”，可以看到字幕的中心出现了一个红色的拖拽标示，用鼠标把字幕拖拽到合适的地方，这个时候字幕编辑区里面的<code>\pos(100,100)</code>会自动改变；</li><li>完成后继续播放视频，重复 7-12 步骤中的操作.</li></ol><p>更新于 2022 年 4 月 6 日.</p></div><h2 id="参考资料">参考资料
<a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99"><small>¶</small></a></h2><p>我的学习主要参考了 <a href="https://unanimated.github.io/ts/lua/ts-auto_tutorial.htm" target="_blank" rel="noreferrer noopener">Lyger, Creating Lua Automation Scripts for Aegisub<b><sub>⧉</sub></b></a>——这篇文章是一篇正儿八经的教程，而且它前面还包含了 lua 语言的基础知识，推荐给大家，值得参考.</p><p>另外 Aegisub 的官方文档也是非常值得参考的，上面推荐的文章也多次引用. 可惜的是，Aegisub 软件已经很长时间没有更新，其官网也缺乏维护，因此无法找到在线的官方文档了，只能是 Google 搜索后下载离线的 PDF 格式文档以备查阅. 还有一篇中文的学习笔记，在这里一并列出：<a href="https://gist.github.com/yin8086/2ee4abd4eef39003eba4440a8a94d4f0" target="_blank" rel="noreferrer noopener">Aegisub32 Lua Script 学习<b><sub>⧉</sub></b></a>.</p><p>其他人写的 lua 脚本：</p><ul><li><a href="https://gitee.com/syler/aegisub-lua/" target="_blank" rel="noreferrer noopener">syler, Gitee 仓库<b><sub>⧉</sub></b></a>. 里面有一个把同一行的中英文字幕分割成两行的脚本.</li><li><a href="https://github.com/magnum357i/Magnum-s-Aegisub-Scripts" target="_blank" rel="noreferrer noopener">magnum357i, GitHub 仓库<b><sub>⧉</sub></b></a>. 里面有超多脚本，只不过我都没有仔细看.</li></ul><h2 id="把中英文的字幕分开">把中英文的字幕分开
<a href="#%e6%8a%8a%e4%b8%ad%e8%8b%b1%e6%96%87%e7%9a%84%e5%ad%97%e5%b9%95%e5%88%86%e5%bc%80"><small>¶</small></a></h2><p>我们在上面写了脚本实现了中英文字幕的混排. 很自然地，我们也会想做一个逆操作，把已经混排的双语字幕分开. 这已经非常简单了，只需要在上面的脚本中简单改几个地方即可：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="cm">--[[
</span></span></span><span class="line"><span class="cl"><span class="cm">说明：
</span></span></span><span class="line"><span class="cl"><span class="cm">    把穿插在一起的中英文字幕分开. 要求用户所选行数一定要是偶数，
</span></span></span><span class="line"><span class="cl"><span class="cm">    且每行英文字幕相邻的下面一行都是其对应的中文字幕.
</span></span></span><span class="line"><span class="cl"><span class="cm">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">script_name</span> <span class="o">=</span> <span class="s1">&#39;分开穿插的双语&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_description</span> <span class="o">=</span> <span class="s1">&#39;把穿插在一起的中英文字幕分开.&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_author</span> <span class="o">=</span> <span class="s1">&#39;Zero&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">script_version</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">seperate</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">sub_backup</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">subi</span><span class="p">,</span> <span class="n">seli</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub_backup</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">slen</span> <span class="o">=</span> <span class="o">#</span><span class="n">sel</span>
</span></span><span class="line"><span class="cl">    <span class="kr">for</span> <span class="n">subi</span><span class="p">,</span> <span class="n">seli</span> <span class="kr">in</span> <span class="n">ipairs</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kr">if</span> <span class="n">subi</span> <span class="o">&lt;=</span> <span class="n">slen</span> <span class="o">/</span> <span class="mi">2</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_backup</span><span class="p">[</span><span class="n">sel</span><span class="p">[</span><span class="n">subi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="kr">elseif</span> <span class="n">subi</span> <span class="o">&gt;</span> <span class="n">slen</span> <span class="o">/</span> <span class="mi">2</span> <span class="kr">then</span>
</span></span><span class="line"><span class="cl">            <span class="n">sub</span><span class="p">[</span><span class="n">seli</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_backup</span><span class="p">[</span><span class="n">sel</span><span class="p">[</span><span class="n">subi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">slen</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">aegisub.set_undo_point</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">sel</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">seperate_validation</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="o">#</span><span class="n">sel</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">aegisub.register_macro</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">script_description</span><span class="p">,</span> <span class="n">seperate</span><span class="p">,</span> <span class="n">seperate_validation</span><span class="p">)</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>有了我写的这两个混排和分开的脚本，再加上上一小节参考资料中提到的 syler 写的把中英文字幕分成两行的脚本，这三个工具在处理双语字幕时已经非常游刃有余了.</p><h2 id="机翻脚本">机翻脚本
<a href="#%e6%9c%ba%e7%bf%bb%e8%84%9a%e6%9c%ac"><small>¶</small></a></h2><p>最后离题记录一下第 7 条关于自动机翻的问题. 我本来想的是，把自动机翻也写成一个 lua 脚本，但我对 lua 的网络库不太熟悉，找了半天也没找到现成的代码，感觉自己写起来会比较费劲，尤其是那个 Google 翻译的 token key 问题，看着就比较棘手. 所以我就转头寻找起了 python 的现成的翻译库：</p><ul><li>googletrans：<a href="https://pypi.org/project/googletrans/" target="_blank" rel="noreferrer noopener">项目主页<b><sub>⧉</sub></b></a>、<a href="https://github.com/ssut/py-googletrans" target="_blank" rel="noreferrer noopener">源代码<b><sub>⧉</sub></b></a>. 这个项目相当于是用非正常手段（aka 爬虫）获得免费翻译的使用，而且它有个优势是可以指定 Google 翻译的服务器地址，因为中国大陆这边访问 translate.google.com 受到限制，但可以访问 translate.google.cn. 不过我尝试的时候遇到了<a href="https://github.com/ssut/py-googletrans/issues/234" target="_blank" rel="noreferrer noopener">问题<b><sub>⧉</sub></b></a>，没有很好的解决办法.</li><li>deep-translator：<a href="https://pypi.org/project/deep-translator/" target="_blank" rel="noreferrer noopener">项目主页<b><sub>⧉</sub></b></a>、<a href="https://github.com/nidhaloff/deep_translator" target="_blank" rel="noreferrer noopener">源代码<b><sub>⧉</sub></b></a>. 这个项目就没法指定 Google 翻译的服务器地址了；它的优势是翻译服务众多：microsoft、Pons、Linguee、Mymemory、Yandex、QCRI、DeepL. 我猜想它们的英译中可能还不如百度翻译，所以没有尝试. DeepL 口碑不错，想试来着，但它需要注册 DeepL 帐号后用自己的 key 去使用官方接口. 可惜 DeepL 不支持中国地区的注册，遂作罢.</li><li>还有很多很多类似的 python 库，但时间有点太久远了，都两三年了，也都没有尝试.</li><li>最后找到一篇文章，<a href="https://1c7.me/translate-subtitle-file/" target="_blank" rel="noreferrer noopener">机翻字幕文件 - 字幕组机翻译小助手<b><sub>⧉</sub></b></a>，虽然是 2018 年的了，不过还是很有借鉴意义. 它让我意识到，各家翻译服务虽然在网页版上是免费的，但没有可以免费调用的官方 api. 要么就写代码和人家的反爬机制做斗争，要不就乖乖交钱使用官方提供的稳定 api. 百度倒是有免费的服务，但也是得注册，而且每秒只能调用 1 次. 该文章作者写了一个<a href="https://github.com/1c7/translate-subtitle-file" target="_blank" rel="noreferrer noopener">软件<b><sub>⧉</sub></b></a>，可以辅助我们（在注册交钱拥有自己的 key 之后）使用各类翻译服务直接翻译字幕软件. 那个软件不支持 Linux，故没有尝试.</li></ul><h2 id="结果">结果
<a href="#%e7%bb%93%e6%9e%9c"><small>¶</small></a></h2><p>其实这篇文章早就写好了，我本来计划把电影字幕翻完之后一起发出来的，但《波士顿市政厅》那个电影太长了，我又很拖延，到 2021 年 3 月底我才翻了半个小时的内容；而且网上找的那个英文字幕问题不少，我还得常常做点英文的听写改正一下……结果就有字幕组接手翻完了：<a href="http://www.orangesub.com/detail/394" target="_blank" rel="noreferrer noopener">orange 字幕组 | 波士顿市政厅<b><sub>⧉</sub></b></a>. 因此把这篇文章直接发出了！</p><p></p><p></p><p></p><p></p></article></div><div class="right_comments"><script src="https://utteranc.es/client.js" repo="zerovip/bcsu" issue-term="pathname" theme="github-light" crossorigin="anonymous" async=""></script></div></div><aside class="toc" id="toc"><button class="toc_title">目录</button><div class="toc_content"><nav id="TableOfContents"><ul><li><a href="#背景与需求">背景与需求</a></li><li><a href="#思路与流程">思路与流程</a></li><li><a href="#遇到的问题">遇到的问题</a></li><li><a href="#脚本放在哪里">脚本放在哪里？</a></li><li><a href="#去掉换行符">去掉换行符</a><ul><li><a href="#脚本的结构">脚本的结构</a></li><li><a href="#lua-代码中要注意的细节">lua 代码中要注意的细节</a></li></ul></li><li><a href="#将中英文字幕混排">将中英文字幕混排</a><ul><li><a href="#关于-aegisub-的验证函数">关于 Aegisub 的验证函数</a></li><li><a href="#lua-代码中要注意的细节-1">lua 代码中要注意的细节</a></li></ul></li><li><a href="#其他">其他</a><ul><li><a href="#参考资料">参考资料</a></li><li><a href="#把中英文的字幕分开">把中英文的字幕分开</a></li><li><a href="#机翻脚本">机翻脚本</a></li><li><a href="#结果">结果</a></li></ul></li></ul></nav></div></aside></div><script src="../../js/main.min.ef0c40d805cf4c70421a1c3d8c1edd6b2fc6a83b39a242da13bf7ea24beb91d4.js"></script></body></html>