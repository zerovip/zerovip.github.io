<!DOCTYPE html>
<html class="theme-container">
<head>
<meta charset="utf-8"/>
<meta content="width=divice-width,initial-scale=1" name="viewport"/>
<meta content="Hugo 0.87.0" name="generator"/>
<title>
Fix the White Flash on Page Load When Using a Dark Mode on a Static Site - Build a Theme
| Zero's Ivory Tower
</title>
<link href="../../css/base.min.7a1b5c1c1d7e43ac09f0cd1df239e034cbdf5fa7439794fb7b5fe1225963173c.css" integrity="sha256-ehtcHB1+Q6wJ8M0d8jngNMvfX6dDl5T7e1/hIlljFzw=" rel="stylesheet" type="text/css"/>
<link href="../../css/small.min.f9c67371e05b88a9468d51903bbe4d52be301b7e498d3f1dc7fbff95f35f2929.css" integrity="sha256-+cZzceBbiKlGjVGQO75NUr4wG35JjT8dx/v/lfNfKSk=" media="screen and (max-width: 1200px)" rel="stylesheet" type="text/css"/>
<link href="../../css/normal.min.b2c3863a3378b939831ae6c21fa348234f23ec0c6879be2c4a92cf6be2a9fa56.css" integrity="sha256-ssOGOjN4uTmDGubCH6NII08j7Axoeb4sSpLPa+Kp+lY=" media="screen and (min-width: 1201px)" rel="stylesheet" type="text/css"/>
<script integrity="sha256-K5dE6m35X2NqrlYpVM4TrdaKnHuZIDyawapGcbYjiVg=" src="../../js/ctheme.min.2b9744ea6df95f636aae562954ce13add68a9c7b99203c9ac1aa4671b6238958.js" type="text/javascript"></script>
<link href="../../css/syntax.min.ed5b37c3a50997d5ccd8b81bf0d00a7ac1f92c82985623c2dbf0cb422596726a.css" integrity="sha256-7Vs3w6UJl9XM2Lgb8NAKesH5LIKYViPC2/DLQiWWcmo=" rel="stylesheet" type="text/css"/>
<script type="application/javascript">var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-143006759-1','auto'),ga('send','pageview'))</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script async="" data-goatcounter="https://zerovip.goatcounter.com/count" src="//gc.zgo.at/count.js"></script>
</head>
<body>
<nav class="bar_for_phone">
<div class="bar_left_button">
<div class="left_button_for_bar" onclick="ChangeClassLeft()">
<div class="bar1"></div>
<div class="bar2"></div>
<div class="bar3"></div>
</div>
</div>
<div class="bar_title">
<a href="../../en/">Zero's Ivory Tower</a>
</div>
<div class="bar_right_button">
<button class="toc_title_for_bar" onclick="ChangeClassTOC()">Table of Content</button>
</div>
</nav>
<div class="body_for_pc">
<aside class="left" id="left">
<div class="left_non-footer">
<div class="left_non-footer_option">
<div class="left_non-footer_option_theme-switch" role="checkbox">
<label class="switch">
<input class="theme-switcher" onchange="themeSwitch()" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
<ul class="left_non-footer_option_language" role="radiogroup">
<li aria-checked="false" class="left_non-footer_option_non-active" role="radio">
<a href="../../zh/01901/">
简体中文 ○
</a>
</li>
<li aria-checked="true" class="left_non-footer_option_active" role="radio">
English ⦿
</li>
<li aria-checked="disabled" class="left_non-footer_option_non-active" role="radio">
Français ⨂
</li>
</ul>
<div class="left_non-footer_option_rss" role="button">
<li class="left_non-footer_option_non-active">
RSS feed ⊠
</li>
</div>
</div>
<header class="left_non-footer_head">
<div class="left_non-footer_head_title">
<a href="../../en/">
Zero's Ivory Tower
</a>
</div>
<div class="left_non-footer_head_subtitle">(●’◡’●)ﾉ</div>
</header>
<nav class="left_non-footer_main">
<div class="h1">
<a href="../../en/math/">MATHEMATICS</a>
</div>
<div class="h2">
<a href="../../en/math/notes/">Math Noes </a>
</div>
<div class="h2">
<a href="../../en/math/stories/">Math Stories </a>
</div>
<div class="h1 active">
<a href="../../en/non-math/">NON-MATHMATICS</a>
</div>
<div class="h2">
<a href="../../en/non-math/journal/">Journal </a>
</div>
<div class="h2">
<a href="../../en/non-math/literature/">Literature </a>
</div>
<div class="h2 active">
<a href="../../en/non-math/memos/">Memos </a>
</div>
<div class="h1">
<a href="../../en/record/">RECORD</a>
</div>
<div class="h2">
<a href="../../en/record/book/">Books Read </a>
</div>
<div class="h2">
<a href="../../en/record/film/">Films Watched </a>
</div>
<div class="h1">
<a href="../../en/about/">ABOUT</a>
</div>
<div class="h2">
<a href="../../en/about/me/">About Me </a>
</div>
<div class="h2">
<a href="../../en/about/site/">About The Site </a>
</div>
</nav>
</div>
<footer class="left_footer">
<div class="copyright">©2019-2021 All Right Reserved.</div>
</footer>
</aside>
<div class="right" onclick="HideBothSide()">
<header class="right_head">
<div class="right_head_title">
Fix the White Flash on Page Load When Using a Dark Mode on a Static Site - Build a Theme
</div>
<div class="right_head_des">
<time>August 27, 2021</time> - 631 words
</div>
</header>
<div class="right_main">
<article class="right_main_article">
<h1 id="the-problem">
The problem
<a href="#the-problem"><small>¶</small></a>
</h1>
<p>This Hugo theme I wrote have had a problem. It defaults to the light mode, but if you switch to the dark mode<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" role="doc-noteref">1</a></sup>, then when loading a new page it will first render the light mode and then automatically switch to the dark, looks like it flashes white a little bit. I thought all the static sites have to face this problem, until one day I found some healthy themes, for instance, <a href="https://adityatelange.github.io/hugo-PaperMod/" rel="noreferrer noopener" target="_blank">PaperMod<b><sub>⧉</sub></b></a>. So, there must be a way to solve this.</p>
<p>I searched this on the internet. There is an article <a href="https://zwbetz.com/fix-the-white-flash-on-page-load-when-using-a-dark-theme-on-a-static-site/" rel="noreferrer noopener" target="_blank">Fix the White Flash on Page Load When Using a Dark Theme on a Static Site<b><sub>⧉</sub></b></a> by the maintainer of <a href="https://github.com/zwbetz-gh/cupper-hugo-theme" rel="noreferrer noopener" target="_blank">theme Cupper<b><sub>⧉</sub></b></a>. I tried their solution. In Chrome, it indeed works; but in Firefox it doesn’t. Firefox will render <code>visibility: hidden; opacity: 0;</code> to a whole blank page, and only after <code>DOMContentLoaded</code> happens <code>showContent()</code> function will show the content. Means: the page still flashes. Before it flashes the <strong>light mode</strong>, now it flashes the <strong>blank page</strong>. Just as bad as before.</p>
<p>I think the difference between Firefox and Chrome is because the developers of Chrome used magic, they tried their best to bring Chrome users a better experience. And this covers up the real problem for the Hugo theme developers who use Chrome.</p>
<h1 id="find-the-cause">
Find the cause
<a href="#find-the-cause"><small>¶</small></a>
</h1>
<p>The main idea is still to understand the process of how the browser render a page. Simply put:</p>
<ul>
<li>You request for a page;</li>
<li>The browser download the entire HTML and save as DOM, then parse and render the page from top to bottom;</li>
<li>Stop parsing when encountering an external CSS or JavaScript file. Download it and then continue;</li>
<li>When encountering <code>&lt;style&gt;&lt;/style&gt;</code> or just loaded external styles, store them as CSSOM and re-render the influential part;</li>
<li>When encountering <code>&lt;script&gt;&lt;/script&gt;</code> or just loaded external scripts, stop parsing and run the scripts. Continue parsing and rendering after finish running them;</li>
<li>So on and so on until all the works are done.</li>
</ul>
<p>The cause to the white flash problem is that I put the JavaScript for theme’s mode switching at the end of <code>&lt;body&gt;</code>, like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- lots of stuff…… --&gt;</span>

        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"changeTheme.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="the-solution">
The solution
<a href="#the-solution"><small>¶</small></a>
</h1>
<p>The solution to this problem is quite simple, with two points:</p>
<ul>
<li>
<ol>
<li>Put the script for theme’s mode switching into <code>&lt;head&gt;</code>, in order to determine the theme currently selected by the user before rendering the body;</li>
</ol>
</li>
<li>
<ol start="2">
<li>Upgrade the container for the theme to the entire <code>&lt;html&gt;</code>, i.e., from</li>
</ol>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span> <span class="na">class</span><span class="o">=</span><span class="s">"theme-container"</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>to</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span> <span class="na">class</span><span class="o">=</span><span class="s">"theme-container"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>This is because <code>&lt;body&gt;</code> has not been rendered at this time, and the only object that can be manipulated by the script in <code>&lt;head&gt;</code> is <code>&lt;html&gt;</code>.</p>
<hr/>
<p>Now the problem is completely solved, the complete code is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">class</span><span class="o">=</span><span class="s">"theme-container"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- lots of stuff…… --&gt;</span>

        <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
            <span class="kr">const</span> <span class="nx">themeContainer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">".theme-container"</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">"theme"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">theme</span> <span class="o">==</span> <span class="s2">"dark"</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">themeContainer</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">"dark"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">theme</span> <span class="o">==</span> <span class="s2">"light"</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">themeContainer</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">"dark"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- lots of stuff…… --&gt;</span>

        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"others.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><section class="footnotes" role="doc-endnotes">
<hr/>
<ol>
<li id="fn:1" role="doc-endnote">
<p>The approach to dark mode in this theme is CSS variable, see <a href="https://dev.to/lampewebdev/css-quickies-css-variables-or-how-you-create-a-white-dark-theme-easily-1i0i" rel="noreferrer noopener" target="_blank">this tutorial<b><sub>⧉</sub></b></a> for reference. <a class="footnote-backref" href="#fnref:1" role="doc-backlink">↩︎</a></p>
</li>
</ol>
</section>
<p></p><p></p><p></p><p></p><p></p><p></p>
<h1>See also</h1>
<li> No.1: Fix the White Flash on Page Load When Using a Dark Mode on a Static Site - Build a Theme (This one!)</li>
<li> No.2: <a href="../../en/15738/">Make Hugo Invert Color for Images when Using a Dark Mode - Build a Theme</a></li>
<p></p><p></p><p></p><p></p>
</article>
</div>
<div class="right_comments">
<script async="" crossorigin="anonymous" issue-term="pathname" repo="zerovip/bcsu" src="https://utteranc.es/client.js" theme="github-light"></script>
</div>
</div>
<aside class="toc" id="toc">
<button class="toc_title">Table of Content</button>
<div class="toc_content">
<nav id="TableOfContents">
<ul>
<li><a href="#the-problem">The problem</a></li>
<li><a href="#find-the-cause">Find the cause</a></li>
<li><a href="#the-solution">The solution</a></li>
</ul>
</nav>
</div>
</aside>
</div>
<script integrity="sha256-CfcE4KgHCzv5vOrf8/U+ODRNGZ65n2pSZDwILCOUXOU=" src="../../js/main.min.09f704e0a8070b3bf9bceadff3f53e38344d199eb99f6a52643c082c23945ce5.js" type="text/javascript"></script>
</body>
</html>